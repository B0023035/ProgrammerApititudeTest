# Draw.io用 - 管理者フロー

## 🔐 管理者ログインフロー

```
START: 管理者がブラウザを開く
  │
  ▼
┌──────────────────────────────────┐
│  管理ダッシュボード入口           │
│  GET /admin                      │
│                                  │
│  MiddleWare: AdminMiddleware     │
│  - 管理者認証確認                │
└──────┬───────────────────────────┘
       │
  認証済み?
    │
 ┌──┴──┐
 │     │
YES    NO
 │     │
 │     ▼
 │   ┌──────────────────┐
 │   │ /admin/login へ  │
 │   │ リダイレクト     │
 │   └──────┬───────────┘
 │          │
 │          ▼
 │   ┌──────────────────────────────┐
 │   │  管理者ログイン画面          │
 │   │  GET /admin/login           │
 │   │                             │
 │   │  入力項目:                  │
 │   │  - メールアドレス           │
 │   │  - パスワード              │
 │   └──────┬──────────────────────┘
 │          │
 │          ▼ POST /admin/login
 │   ┌──────────────────────────────┐
 │   │ AdminAuthController::login  │
 │   │ - バリデーション            │
 │   │ - メール確認               │
 │   └──────┬──────────────────────┘
 │          │
 │          ▼
 │   ┌──────────────────────────────┐
 │   │ Database Query               │
 │   │ SELECT * FROM admins         │
 │   │ WHERE email = ?              │
 │   └──────┬──────────────────────┘
 │          │
 │      ┌───┴────┐
 │      │ verify  │
 │      │ password│
 │      └───┬────┘
 │          │
 │      ┌───┴──┐
 │      │      │
 │     OK    NG
 │      │     │
 │      │     ▼
 │      │   ┌─────────────────┐
 │      │   │ エラー表示      │
 │      │   │ "認証失敗"      │
 │      │   └────────┬────────┘
 │      │            │
 │      │            ▼
 │      │        ログイン画面
 │      │
 │      ▼
 │   ┌──────────────────────────────┐
 │   │ Session Created              │
 │   │ (guard: admin)               │
 │   │ - admin_id                   │
 │   │ - authenticated_at           │
 │   └──────┬──────────────────────┘
 │          │
 ▼          ▼
┌──────────────────────────────────┐
│ 管理ダッシュボード                │
│ GET /admin                       │
│                                  │
│ ナビゲーション:                  │
│ - イベント管理                   │
│ - 結果確認                       │
│ - ユーザー管理                   │
│ - 問題管理                       │
│ - ログアウト                     │
└──────────────────────────────────┘
```

## 📋 管理者 - イベント管理フロー

```
START: 管理者がダッシュボード
  │
  ▼
┌──────────────────────────────┐
│ [イベント管理]               │
│ GET /admin/events            │
└──────┬───────────────────────┘
       │
       ▼
┌──────────────────────────────────────┐
│ EventManagementController::index     │
│                                      │
│ SELECT * FROM events                 │
│ ORDER BY created_at DESC             │
└──────┬───────────────────────────────┘
       │
       ▼
┌──────────────────────────────────────┐
│ イベント一覧表示                      │
│                                      │
│ テーブル表示:                        │
│ ├─ イベント名                        │
│ ├─ 開始日時                         │
│ ├─ 終了日時                         │
│ ├─ ステータス (受付中/終了/未開始)  │
│ ├─ 受験者数                         │
│ ├─ [編集] [削除] [詳細]             │
│ └─ ページネーション                  │
│                                      │
│ [新規イベント作成]                   │
└──────┬───────────────────────────────┘
       │
       ├─ 新規作成
       │  │
       │  ▼
       │ ┌─────────────────────────────┐
       │ │ イベント作成フォーム         │
       │ │ GET /admin/events/create    │
       │ │                             │
       │ │ 入力項目:                   │
       │ │ - イベント名               │
       │ │ - セッションコード (passphrase)
       │ │ - 開始日時                 │
       │ │ - 終了日時                 │
       │ │ - 試験タイプ               │
       │ │ - Part別問題数             │
       │ │ - 制限時間                 │
       │ │ [作成]                     │
       │ └──────┬──────────────────────┘
       │        │
       │        ▼ POST /admin/events
       │ ┌──────────────────────────────┐
       │ │ EventManagementController    │
       │ │ ::store                      │
       │ │ - バリデーション             │
       │ │ - 日時確認                  │
       │ └──────┬───────────────────────┘
       │        │
       │        ▼
       │ ┌──────────────────────────────┐
       │ │ INSERT INTO events           │
       │ │ - name                       │
       │ │ - passphrase (unique)        │
       │ │ - begin_at                   │
       │ │ - end_at                     │
       │ │ - exam_type                  │
       │ │ - part1_questions            │
       │ │ - part2_questions            │
       │ │ - part3_questions            │
       │ │ - time_limit                 │
       │ │ - created_at                 │
       │ └──────┬───────────────────────┘
       │        │
       │        ▼
       │    ✓ Created
       │    リダイレクト to イベント一覧
       │
       │
       ├─ 編集
       │  │
       │  ▼
       │ ┌──────────────────────────────┐
       │ │ イベント編集フォーム         │
       │ │ GET /admin/events/{id}/edit  │
       │ │                              │
       │ │ (既存内容を表示)             │
       │ │ [保存] [キャンセル]          │
       │ └──────┬───────────────────────┘
       │        │
       │        ▼ POST /admin/events/{id}
       │ ┌──────────────────────────────┐
       │ │ EventManagementController    │
       │ │ ::update                     │
       │ │ - バリデーション             │
       │ └──────┬───────────────────────┘
       │        │
       │        ▼
       │ ┌──────────────────────────────┐
       │ │ UPDATE events               │
       │ │ WHERE id = ?                │
       │ └──────┬───────────────────────┘
       │        │
       │        ▼
       │    ✓ Updated
       │
       │
       └─ 詳細確認
          │
          ▼
         ┌─────────────────────────────┐
         │ イベント詳細                 │
         │ GET /admin/events/{id}      │
         │                             │
         │ 表示内容:                   │
         │ - イベント情報              │
         │ - 受験者一覧               │
         │ - 問題設定確認             │
         │ - [問題を管理]             │
         │ - [結果を確認]             │
         └─────────────────────────────┘
```

## 📊 管理者 - 結果管理フロー

```
START: 管理者がダッシュボード
  │
  ▼
┌──────────────────────────────┐
│ [結果確認]                   │
│ GET /admin/results           │
└──────┬───────────────────────┘
       │
       ▼
┌──────────────────────────────────────┐
│ ResultsManagementController::index   │
│                                      │
│ SELECT exam_sessions                 │
│ JOIN users ON ...                    │
│ JOIN events ON ...                   │
│ ORDER BY completed_at DESC           │
└──────┬───────────────────────────────┘
       │
       ▼
┌──────────────────────────────────────┐
│ 試験結果一覧                          │
│                                      │
│ フィルター:                          │
│ - イベント選択                       │
│ - 日付範囲                           │
│ - スコア範囲                         │
│                                      │
│ テーブル表示:                        │
│ ├─ ユーザー名                        │
│ ├─ イベント名                        │
│ ├─ 受験日時                         │
│ ├─ スコア                           │
│ ├─ 成績レベル                       │
│ └─ [詳細]                           │
│                                      │
│ [CSVエクスポート]                    │
│ [レポート生成]                       │
└──────┬───────────────────────────────┘
       │
       │ (詳細をクリック)
       │
       ▼
┌──────────────────────────────────────┐
│ 個別結果詳細                          │
│ GET /admin/results/{sessionId}      │
│                                      │
│ 表示内容:                            │
│ - ユーザー情報                       │
│ - Part別スコア                      │
│ - 正解/不正解一覧                   │
│ - 受験時間                          │
│ - 不正検知ログ                      │
│ - [不正判定] (アクション)           │
│ - [認定] (アクション)               │
└──────────────────────────────────────┘
```

## 🚨 管理者 - 不正検知管理

```
システムが検知
    │
    ▼
┌──────────────────────────┐
│ exam_violations テーブルに │
│ レコード追加              │
│                          │
│ - exam_session_id        │
│ - violation_type         │
│ - details (JSON)         │
│ - created_at             │
└──────┬───────────────────┘
       │
       ▼
┌──────────────────────────────────┐
│ 管理画面に警告表示                │
│ GET /admin/violations           │
│                                  │
│ フラグ: ⚠️ 不正検知あり           │
└──────┬───────────────────────────┘
       │
       ▼
┌──────────────────────────────────┐
│ 管理者が確認                       │
│ [詳細を見る]                      │
└──────┬───────────────────────────┘
       │
       ▼
┌──────────────────────────────────┐
│ 不正検知ログ確認                  │
│                                  │
│ - 検知タイプ                     │
│   * window_focus_lost            │
│   * tab_switch_detected          │
│   * unauthorized_copy            │
│ - 検知日時                       │
│ - 詳細情報                       │
└──────┬───────────────────────────┘
       │
       ▼
┌──────────────────────────────────┐
│ 管理者のアクション選択             │
│                                  │
│ [対象成績を無効化]                │
│ または                           │
│ [注記を付けて保持]                │
│ または                           │
│ [問題なしと判定]                 │
└──────────────────────────────────┘
```

## 👤 管理者権限と機能一覧

```
┌──────────────────────────────────────────────────────────┐
│              管理者が実行可能なアクション                 │
├──────────────────────────────────────────────────────────┤
│                                                          │
│ ✓ イベント管理                                           │
│   ├─ 新規作成                                           │
│   ├─ 編集                                              │
│   ├─ 削除                                              │
│   └─ 参加ユーザー確認                                  │
│                                                          │
│ ✓ 問題管理                                              │
│   ├─ 問題登録                                          │
│   ├─ 選択肢登録                                        │
│   ├─ 画像アップロード                                  │
│   └─ 問題編集/削除                                     │
│                                                          │
│ ✓ ユーザー管理                                          │
│   ├─ ユーザー一覧表示                                  │
│   ├─ ユーザー情報確認                                  │
│   ├─ ユーザー削除                                      │
│   └─ 登録/未登録者確認                                 │
│                                                          │
│ ✓ 結果管理                                              │
│   ├─ 成績確認 (全体・個別)                              │
│   ├─ CSV エクスポート                                   │
│   ├─ 不正判定                                          │
│   └─ 成績確定                                          │
│                                                          │
│ ✓ セキュリティ                                          │
│   ├─ 不正検知ログ確認                                  │
│   ├─ 不正フラグ設定                                    │
│   └─ ユーザー制限設定                                  │
│                                                          │
│ ✓ レポート                                              │
│   ├─ スコア分布図                                      │
│   ├─ 問題別正解率                                      │
│   ├─ 比較統計                                          │
│   └─ PDF 出力                                          │
│                                                          │
└──────────────────────────────────────────────────────────┘
```
