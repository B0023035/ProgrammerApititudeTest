# システム構成図案 - 1. 基本3層アーキテクチャ

## 📐 シンプルな3層構成

```
┌─────────────────────────────────────────────────────────────┐
│                      プレゼンテーション層                    │
│                   (クライアント・UI)                        │
│                                                              │
│  ┌─────────────────────────────────────────────────────┐  │
│  │                                                      │  │
│  │   Vue 3 + Inertia.js                               │  │
│  │   ・セッションコード入力                            │  │
│  │   ・ユーザーログイン                                │  │
│  │   ・試験問題表示                                    │  │
│  │   ・成績表示                                        │  │
│  │   ・管理者ダッシュボード                            │  │
│  │                                                      │  │
│  │   Tailwind CSS (デザイン)                          │  │
│  │                                                      │  │
│  └─────────────────────────────────────────────────────┘  │
│                           │                                  │
│                HTTP/HTTPS (CSRF保護)                        │
│                           │                                  │
└───────────────────────────┼──────────────────────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────────────┐
│                   ビジネスロジック層                          │
│                  (サーバー側処理)                           │
│                                                              │
│  ┌─────────────────────────────────────────────────────┐  │
│  │                                                      │  │
│  │   Laravel 11 (PHP 8.4)                             │  │
│  │   ・ルーティング (routing)                          │  │
│  │   ・認証処理 (Authentication)                       │  │
│  │   ・コントローラー (Controllers)                    │  │
│  │   ・ビジネスロジック                                │  │
│  │   ・成績計算                                        │  │
│  │   ・不正検知                                        │  │
│  │   ・ミドルウェア (CSRF, Auth)                       │  │
│  │                                                      │  │
│  └─────────────────────────────────────────────────────┘  │
│                           │                                  │
│                      DB Query (SQL)                          │
│                           │                                  │
└───────────────────────────┼──────────────────────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────────────┐
│                        データ層                              │
│                   (永続データ保存)                          │
│                                                              │
│  ┌─────────────────────────────────────────────────────┐  │
│  │                                                      │  │
│  │   MySQL 8.0                                         │  │
│  │   ・Users テーブル                                 │  │
│  │   ・Admins テーブル                                │  │
│  │   ・Events (試験イベント)                          │  │
│  │   ・ExamSessions (試験セッション)                 │  │
│  │   ・Questions & Choices (問題)                    │  │
│  │   ・Answers (ユーザー解答)                         │  │
│  │   ・ExamViolations (不正ログ)                     │  │
│  │   ・PracticeQuestions (練習問題)                  │  │
│  │                                                      │  │
│  └─────────────────────────────────────────────────────┘  │
│                                                              │
└─────────────────────────────────────────────────────────────┘
```

---

## 📊 データフロー図

```
ユーザーのブラウザ
       │
       │ 1️⃣ HTTP リクエスト
       │ (セッションコード/ログイン/解答)
       │
       ▼
Inertia.js Router
       │
       │ ルート確認
       │
       ▼
Middleware
       │
       ├─ CSRF Token検証
       ├─ Auth確認
       ├─ Session確認
       └─ 権限確認
       │
       ▼
Controller
       │
       ├─ バリデーション
       ├─ ビジネスロジック
       │  ├─ 認証処理
       │  ├─ 成績計算
       │  └─ 不正検知
       │
       ▼
Model (Eloquent ORM)
       │
       │ 2️⃣ SQL Query
       │
       ▼
MySQL Database
       │
       │ 3️⃣ レコード返却
       │
       ▼
Model → Controller
       │
       │ 4️⃣ Response (JSON)
       │ with Props
       │
       ▼
Inertia.js
       │
       ▼
Vue Component
       │
       │ 5️⃣ HTML レンダリング
       │
       ▼
ブラウザ表示
```

---

## 🔒 セキュリティレイヤー

```
┌──────────────────────────────────────────┐
│ Layer 1: HTTPS/TLS                      │
│ 通信の暗号化                            │
└──────────────────────────────────────────┘
              │
              ▼
┌──────────────────────────────────────────┐
│ Layer 2: CSRF Token Verification        │
│ 悪いサイトからの攻撃防止                │
└──────────────────────────────────────────┘
              │
              ▼
┌──────────────────────────────────────────┐
│ Layer 3: Authentication                 │
│ ログイン認証 (Email + Password)         │
└──────────────────────────────────────────┘
              │
              ▼
┌──────────────────────────────────────────┐
│ Layer 4: Session Management             │
│ セッション確認・タイムアウト            │
└──────────────────────────────────────────┘
              │
              ▼
┌──────────────────────────────────────────┐
│ Layer 5: Authorization                  │
│ 権限確認 (User/Admin/Guest)             │
└──────────────────────────────────────────┘
              │
              ▼
┌──────────────────────────────────────────┐
│ Layer 6: Input Validation               │
│ 入力値のバリデーション                  │
└──────────────────────────────────────────┘
              │
              ▼
┌──────────────────────────────────────────┐
│ Layer 7: Database Encryption            │
│ パスワード暗号化など                    │
└──────────────────────────────────────────┘
```

---

## 🔄 ユーザーの流れ (フロー図)

```
┌────────────────────┐
│ ゲストユーザー      │
└────────┬───────────┘
         │ セッションコード入力
         ▼
┌────────────────────────┐
│ SessionCodeController  │
│ - コード検証            │
│ - イベント確認          │
└────────┬───────────────┘
         │
         ▼
┌──────────────────────┐    
│ ゲスト情報入力        │ ※登録なし
│ (名前・学年など)     │
└────────┬─────────────┘
         │
         ▼
┌──────────────────────┐
│ 試験実施              │
│ (ExamController)     │
│ - Part 1/2/3        │
│ - 90問解答          │
│ - 不正監視          │
└────────┬─────────────┘
         │
         ▼
┌──────────────────────┐
│ 自動採点・成績表示    │
│ - Part別スコア      │
│ - 総得点            │
└──────────────────────┘


┌────────────────────┐
│ ユーザー (認証)     │
└────────┬───────────┘
         │ メール+パスワード
         ▼
┌────────────────────────┐
│ AuthController         │
│ - ログイン処理         │
│ - Session作成         │
└────────┬───────────────┘
         │
         ▼
┌──────────────────────┐
│ ダッシュボード        │
│ - 試験選択           │
│ - 過去結果確認       │
│ - 練習問題           │
└────────┬─────────────┘
         │
         ▼
┌──────────────────────┐
│ 試験実施 (同上)      │
└──────────────────────┘


┌────────────────────┐
│ 管理者              │
└────────┬───────────┘
         │ メール+パスワード
         ▼
┌────────────────────────┐
│ AdminAuthController    │
│ - 管理者ログイン       │
└────────┬───────────────┘
         │
         ▼
┌──────────────────────┐
│ 管理ダッシュボード    │
│ - イベント管理       │
│ - 問題管理          │
│ - 成績確認          │
│ - 不正管理          │
└──────────────────────┘
```

---

## 🗄️ データベース構成

```
┌─────────────────────────────────────────────────────────┐
│                      MySQL Database                     │
├─────────────────────────────────────────────────────────┤
│                                                          │
│ ┌─────────────────┐  ┌──────────────────┐            │
│ │ users           │  │ admins           │            │
│ │ (一般ユーザー)  │  │ (管理者)         │            │
│ └────────┬────────┘  └────────┬─────────┘            │
│          │                    │                       │
│          └────────┬───────────┘                       │
│                   │                                    │
│                   ▼                                    │
│         ┌──────────────────┐                         │
│         │ exam_sessions    │                         │
│         │ (試験セッション) │                         │
│         └────────┬─────────┘                         │
│                  │                                    │
│         ┌────────┴────────┐                          │
│         │                 │                          │
│         ▼                 ▼                          │
│    ┌────────────┐  ┌──────────────┐               │
│    │ answers    │  │ events       │               │
│    │ (解答)     │  │ (試験イベント)│               │
│    └────────────┘  └──────┬───────┘               │
│                            │                        │
│                            ▼                        │
│                     ┌──────────────┐              │
│                     │ questions    │              │
│                     │ (問題)       │              │
│                     └──────┬───────┘              │
│                            │                        │
│                            ▼                        │
│                     ┌──────────────┐              │
│                     │ choices      │              │
│                     │ (選択肢)     │              │
│                     └──────────────┘              │
│                                                    │
│ ┌─────────────────┐  ┌──────────────────┐        │
│ │practice_        │  │exam_violations  │        │
│ │questions        │  │(不正ログ)       │        │
│ │(練習問題)       │  │                  │        │
│ └─────────────────┘  └──────────────────┘        │
│                                                    │
└────────────────────────────────────────────────────┘
```

---

## 🚀 デプロイメント環境

```
┌─────────────────────────────────────┐
│        Docker コンテナ環境            │
│                                     │
│ ┌──────────────────────────────┐  │
│ │ Laravel App Container        │  │
│ │ ・PHP 8.4                   │  │
│ │ ・Laravel 11                │  │
│ │ ・ポート: 8000              │  │
│ └──────────────────────────────┘  │
│                                     │
│ ┌──────────────────────────────┐  │
│ │ MySQL Container              │  │
│ │ ・MySQL 8.0                 │  │
│ │ ・ポート: 3306              │  │
│ └──────────────────────────────┘  │
│                                     │
│ ┌──────────────────────────────┐  │
│ │ Redis Container (optional)  │  │
│ │ ・キャッシング              │  │
│ │ ・セッション管理            │  │
│ └──────────────────────────────┘  │
│                                     │
└─────────────────────────────────────┘
         │
         │ (Docker Compose)
         │
    デプロイ可能
```

---

## 📊 レスポンスタイム (目安)

```
クライアント側の操作
   │
   ├─ ページロード: 500-1000ms
   │
   ├─ 問題表示: 100-300ms
   │
   ├─ 解答送信: 200-500ms
   │
   ├─ 成績計算: 1-2秒 (全90問の場合)
   │
   └─ 管理者ダッシュボード: 500-1500ms
```

---

## ✨ まとめ図

```
┌──────────────────────────────────────────────────────┐
│          プログラマー適性検査システム全体             │
├──────────────────────────────────────────────────────┤
│                                                      │
│  【フロントエンド】                                 │
│  ├─ Vue 3 (ユーザーUI)                             │
│  ├─ Inertia.js (サーバー連携)                      │
│  └─ Tailwind CSS (デザイン)                        │
│                                                      │
│  ↕️ (HTTPS + CSRF保護)                             │
│                                                      │
│  【バックエンド】                                   │
│  ├─ Laravel 11 (ビジネスロジック)                  │
│  ├─ PHP 8.4 (言語)                                │
│  └─ Eloquent ORM (DB操作)                         │
│                                                      │
│  ↕️ (SQL)                                          │
│                                                      │
│  【データベース】                                   │
│  ├─ MySQL 8.0                                      │
│  ├─ 8テーブル                                      │
│  └─ リレーション設計                               │
│                                                      │
│  【セキュリティ】                                   │
│  ├─ 7層防御                                        │
│  ├─ 不正検知                                       │
│  └─ 暗号化                                         │
│                                                      │
│  【実行環境】                                       │
│  ├─ Docker + Sail                                 │
│  └─ どのサーバーでも同じ環境                      │
│                                                      │
└──────────────────────────────────────────────────────┘
```
