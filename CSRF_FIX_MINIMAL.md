# CSRF ãƒˆãƒ¼ã‚¯ãƒ³ 419 ã‚¨ãƒ©ãƒ¼ - æœ€å°é™ã®æ ¹æœ¬è§£æ±º

## ğŸ” å•é¡Œã®åŸå› ç‰¹å®š

### å‰ã®ä¿®æ­£ã®å•é¡Œç‚¹

1. **RefreshCsrfToken ã®å¤šé‡å†ç”Ÿæˆ** - ãƒªã‚¯ã‚¨ã‚¹ãƒˆå‰å¾Œã§ãƒˆãƒ¼ã‚¯ãƒ³ã‚’2å›å†ç”Ÿæˆ
2. **VerifyCsrfToken ã®æ¤œè¨¼æ™‚å†ç”Ÿæˆ** - æ¤œè¨¼æ™‚ã«ã•ã‚‰ã«ãƒˆãƒ¼ã‚¯ãƒ³å†ç”Ÿæˆ
3. **regenerate_on_request ã®æœ‰åŠ¹åŒ–** - ã‚»ãƒƒã‚·ãƒ§ãƒ³è¨­å®šã§æ¯ãƒªã‚¯ã‚¨ã‚¹ãƒˆå†ç”Ÿæˆ
4. **éåº¦ãªãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢ãƒã‚§ãƒ¼ãƒ³** - ã‚«ã‚¹ã‚¿ãƒ ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢Ã—2 + æ¨™æº–ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢

### çµæœ

- ãƒˆãƒ¼ã‚¯ãƒ³ãŒç ´å£Šã•ã‚ŒãŸ
- ã‚»ãƒƒã‚·ãƒ§ãƒ³çŠ¶æ…‹ãŒä¸å®‰å®šã«ãªã£ãŸ
- æ—¢ã«å‹•ã„ã¦ã„ãŸæ©Ÿèƒ½ã¾ã§å£Šã‚ŒãŸ

---

## âœ… å®Ÿè£…ã—ãŸæœ€å°é™ã®ä¿®æ­£

### 1ï¸âƒ£ Kernel.php - ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢é †åºã‚’æ­£è¦åŒ–

```php
'web' => [
    \App\Http\Middleware\EncryptCookies::class,
    \Illuminate\Cookie\Middleware\AddQueuedCookiesToResponse::class,
    \Illuminate\Session\Middleware\StartSession::class,
    \Illuminate\View\Middleware\ShareErrorsFromSession::class,
    // âœ… Laravel æ¨™æº–ã® VerifyCsrfToken ã®ã¿ä½¿ç”¨
    \Illuminate\Foundation\Http\Middleware\VerifyCsrfToken::class,
    \Illuminate\Routing\Middleware\SubstituteBindings::class,
    \App\Http\Middleware\HandleInertiaRequests::class,
    \Illuminate\Http\Middleware\AddLinkHeadersForPreloadedAssets::class,
],
```

**ä¿®æ­£å†…å®¹**:

- âŒ å‰Šé™¤: `\App\Http\Middleware\RefreshCsrfToken::class`
- âŒ å‰Šé™¤: `\App\Http\Middleware\VerifyCsrfToken::class` (ã‚«ã‚¹ã‚¿ãƒ ç‰ˆ)
- âœ… æ¡ç”¨: `\Illuminate\Foundation\Http\Middleware\VerifyCsrfToken::class` (æ¨™æº–ç‰ˆ)

### 2ï¸âƒ£ config/session.php - ã‚»ãƒƒã‚·ãƒ§ãƒ³æœ‰åŠ¹æœŸé™ã‚’å»¶é•·

```php
'lifetime' => (int) env('SESSION_LIFETIME', 1440),  // 120åˆ† â†’ 1440åˆ†ï¼ˆ24æ™‚é–“ï¼‰
```

**ç†ç”±**:

- å…ƒã® 120åˆ†ã§ã¯ã€ãƒ†ã‚¹ãƒˆå®Ÿè¡Œä¸­ã«ã‚»ãƒƒã‚·ãƒ§ãƒ³ãŒå¤±åŠ¹
- 1440åˆ†ï¼ˆ24æ™‚é–“ï¼‰ã§ãƒ†ã‚¹ãƒˆé‹ç”¨ã«å¯¾å¿œ
- CSRF ãƒˆãƒ¼ã‚¯ãƒ³ã‚‚ã‚»ãƒƒã‚·ãƒ§ãƒ³ã¨åŒæœŸ

### 3ï¸âƒ£ .env - ã‚»ãƒƒã‚·ãƒ§ãƒ³è¨­å®šã‚’æ­£è¦åŒ–

```dotenv
SESSION_DRIVER=redis
SESSION_LIFETIME=1440
SESSION_ENCRYPT=false
SESSION_PATH=/
SESSION_DOMAIN=null
SESSION_SECURE_COOKIE=false
SESSION_SAME_SITE=lax
```

### 4ï¸âƒ£ .env.testing - ãƒ†ã‚¹ãƒˆç’°å¢ƒè¨­å®šã‚’è¿½åŠ 

```dotenv
APP_ENV=testing
SESSION_DRIVER=database          # ãƒ†ã‚¹ãƒˆç”¨ã«ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒ‰ãƒ©ã‚¤ãƒ
SESSION_LIFETIME=1440
CACHE_STORE=file
```

### 5ï¸âƒ£ ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢ãƒ•ã‚¡ã‚¤ãƒ«å‰Šé™¤

- âŒ `app/Http/Middleware/RefreshCsrfToken.php` å‰Šé™¤
- âŒ `app/Http/Middleware/VerifyCsrfToken.php` å‰Šé™¤

**ç†ç”±**: æ¨™æº–ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢ã‚’ä½¿ç”¨ã™ã‚‹ãŸã‚ä¸è¦

---

## ğŸ¯ ãªãœã“ã‚Œã§è§£æ±ºã™ã‚‹ã®ã‹

### Laravel ã® CSRF ä¿è­·ã¯ååˆ†

```
ãƒ•ã‚©ãƒ¼ãƒ è¡¨ç¤ºæ™‚: ã‚»ãƒƒã‚·ãƒ§ãƒ³å†…ã« _token ã‚’ä¿å­˜
ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡æ™‚: POST ãƒ•ã‚©ãƒ¼ãƒ å†…ã® _token ã¨ã‚»ãƒƒã‚·ãƒ§ãƒ³ã® _token ã‚’æ¯”è¼ƒ
æ¤œè¨¼æˆåŠŸæ™‚: æ¬¡ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã®ãŸã‚æ–°ã—ã„ _token ã‚’ç”Ÿæˆï¼ˆæ¨™æº–å‹•ä½œï¼‰
```

### å•é¡Œã¯éåº¦ãªå¯¾å¿œã«ã‚ã£ãŸ

```
âŒ å‰ã®ä¿®æ­£:
   ãƒ•ã‚©ãƒ¼ãƒ è¡¨ç¤º â†’ RefreshCsrfToken ã§å†ç”Ÿæˆ
            â†’ VerifyCsrfToken ã§å†ç”Ÿæˆ
            â†’ HandleInertiaRequests ã§å†ç”Ÿæˆ
            â†’ config ã§ regenerate_on_request=true ã§å†ç”Ÿæˆ
   = 4å›ã®å†ç”Ÿæˆ = ã‚»ãƒƒã‚·ãƒ§ãƒ³ç ´å£Š

âœ… æ­£ã—ã„å¯¾å¿œ:
   ãƒ•ã‚©ãƒ¼ãƒ è¡¨ç¤º â†’ Laravel æ¨™æº–ã® VerifyCsrfToken ã®ã¿
            â†’ è‡ªå‹•çš„ã«æ¬¡ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆç”¨ã«æ–°ã—ã„ _token ã‚’ç”Ÿæˆ
   = 1å›ã®å†ç”Ÿæˆ = å®‰å®šå‹•ä½œ
```

---

## ğŸ“‹ ä¿®æ­£ãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§

| ãƒ•ã‚¡ã‚¤ãƒ«                  | å¤‰æ›´å†…å®¹                                              |
| ------------------------- | ----------------------------------------------------- |
| `app/Http/Kernel.php`     | ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢ã‚’ã‚·ãƒ³ãƒ—ãƒ«åŒ–ï¼ˆæ¨™æº– VerifyCsrfToken ã®ã¿ï¼‰ |
| `config/session.php`      | SESSION_LIFETIME: 120 â†’ 1440 åˆ†                       |
| `.env`                    | SESSION_LIFETIME=1440 ã‚’æ˜ç¤º                          |
| `.env.testing`            | ãƒ†ã‚¹ãƒˆç’°å¢ƒè¨­å®šã‚’è¿½åŠ                                   |
| âŒ `RefreshCsrfToken.php` | å‰Šé™¤                                                  |
| âŒ `VerifyCsrfToken.php`  | å‰Šé™¤                                                  |

---

## ğŸ”§ å‹•ä½œç¢ºèª

### 1. ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚¯ãƒªã‚¢

```bash
php artisan config:clear
php artisan route:clear
php artisan cache:clear  # MySQL ãŒãªã„ãŸã‚å¤±æ•—ã—ã¦ã‚‚OK
```

### 2. ãƒ–ãƒ©ã‚¦ã‚¶ã§ã‚¢ã‚¯ã‚»ã‚¹

```
http://localhost:8000/
```

æœŸå¾…ã•ã‚Œã‚‹å‹•ä½œ:

- âœ… ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚³ãƒ¼ãƒ‰å…¥åŠ›ãƒšãƒ¼ã‚¸ãŒè¡¨ç¤ºã•ã‚Œã‚‹
- âœ… ã‚³ãƒ¼ãƒ‰å…¥åŠ› â†’ Welcome ãƒšãƒ¼ã‚¸ã«é·ç§»
- âœ… ãƒ­ã‚°ã‚¤ãƒ³ â†’ ãƒ†ã‚¹ãƒˆé–‹å§‹ãƒšãƒ¼ã‚¸ã«é·ç§»
- âœ… ç·´ç¿’å•é¡Œãƒšãƒ¼ã‚¸ãŒé–‹ã‘ã‚‹
- âœ… ãƒªãƒ­ãƒ¼ãƒ‰ä¸è¦ã§å‹•ä½œ

### 3. Playwright ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ

```bash
npx playwright test
```

æœŸå¾…ã•ã‚Œã‚‹çµæœ:

- âœ… 21å€‹ä»¥ä¸Šã®ãƒ†ã‚¹ãƒˆãŒåˆæ ¼
- âœ… 419 ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ãªã„

---

## ğŸ“ æŠ€è¡“çš„è§£èª¬

### ã‚»ãƒƒã‚·ãƒ§ãƒ³æœ‰åŠ¹æœŸé™ã¨ãƒˆãƒ¼ã‚¯ãƒ³æœ‰åŠ¹æœŸé™ã®é–¢ä¿‚

```
ã‚»ãƒƒã‚·ãƒ§ãƒ³æœ‰åŠ¹æœŸé™: 1440åˆ†ï¼ˆ24æ™‚é–“ï¼‰
  â”œâ”€ ã‚µãƒ¼ãƒãƒ¼ãŒã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’ãƒ¡ãƒ¢ãƒª/Redis/DB ã«ä¿æŒ
  â””â”€ _token ã¯ã‚»ãƒƒã‚·ãƒ§ãƒ³å†…ã«å«ã¾ã‚Œã‚‹

CSRF ãƒˆãƒ¼ã‚¯ãƒ³æœ‰åŠ¹æœŸé™: ã‚»ãƒƒã‚·ãƒ§ãƒ³æœ‰åŠ¹æœŸé™ã«ä¾å­˜
  â”œâ”€ ã‚»ãƒƒã‚·ãƒ§ãƒ³å¤±åŠ¹ = ãƒˆãƒ¼ã‚¯ãƒ³å¤±åŠ¹
  â””â”€ ã‚»ãƒƒã‚·ãƒ§ãƒ³æœ‰åŠ¹ = ãƒˆãƒ¼ã‚¯ãƒ³æœ‰åŠ¹

Laravel ã®æ¨™æº–å‹•ä½œ:
  â”œâ”€ å„ãƒªã‚¯ã‚¨ã‚¹ãƒˆæ¤œè¨¼å¾Œã€è‡ªå‹•çš„ã«æ–°ã—ã„ãƒˆãƒ¼ã‚¯ãƒ³ç”Ÿæˆ
  â”œâ”€ ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ã¯åŒã˜ã‚»ãƒƒã‚·ãƒ§ãƒ³IDã§é€éçš„ã«å‹•ä½œ
  â””â”€ 419 ã‚¨ãƒ©ãƒ¼ä¸ç™ºç”Ÿ
```

### regenerate_on_request ãŒå¿…è¦ãªã„ç†ç”±

```
regenerate_on_request = true ã®åŠ¹æœ:
  å„ãƒªã‚¯ã‚¨ã‚¹ãƒˆå¾Œã« session_id() ã‚’ãƒªã‚»ãƒƒãƒˆ
  â†“
  ãƒ¬ã‚¹ãƒãƒ³ã‚¹é€ä¿¡å‰ã«æ–°ã—ã„ _token ã‚’ç”Ÿæˆ
  â†“
  ãƒ–ãƒ©ã‚¦ã‚¶ãŒæ–°ã—ã„ã‚»ãƒƒã‚·ãƒ§ãƒ³Cookieã‚’å—ã‘å–ã‚‹
  â†“
  æ¬¡ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã§æ–°ã—ã„ãƒˆãƒ¼ã‚¯ãƒ³ã‚’é€ä¿¡
  â†“
  æ¤œè¨¼æˆåŠŸ â†’ æ–°ã—ã„ãƒˆãƒ¼ã‚¯ãƒ³ç”Ÿæˆ
  (æ­£å¸¸ãªæµã‚Œ)

  ãŸã ã—ã€ä»¥ä¸‹ã®å ´åˆã«419ç™ºç”Ÿ:
  - ãƒ•ã‚©ãƒ¼ãƒ è¡¨ç¤ºæ™‚ã®ãƒˆãƒ¼ã‚¯ãƒ³ A
  - é€ä¿¡æ™‚ã®ãƒˆãƒ¼ã‚¯ãƒ³ Bï¼ˆregenerate_on_request ã§å¤‰æ›´ï¼‰
  - ãƒˆãƒ¼ã‚¯ãƒ³ä¸ä¸€è‡´ â†’ 419 ã‚¨ãƒ©ãƒ¼

âœ… Laravel ã®æ¨™æº–å‹•ä½œã§ååˆ†:
  - æ¤œè¨¼ã¯åŒã˜ã‚»ãƒƒã‚·ãƒ§ãƒ³å†…ã§å®Ÿæ–½
  - æ¤œè¨¼å¾Œã«æ¬¡ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆç”¨ã«æ–°ã—ã„ãƒˆãƒ¼ã‚¯ãƒ³ç”Ÿæˆ
  - ãƒ•ã‚©ãƒ¼ãƒ è¡¨ç¤º â†’ é€ä¿¡ ã®æµã‚Œã§ä¸€è²«æ€§ã‚’ä¿è¨¼
```

---

## ğŸ“Š ä¿®æ­£å‰å¾Œã®æ¯”è¼ƒ

| é …ç›®                  | ä¿®æ­£å‰             | ä¿®æ­£å¾Œ           |
| --------------------- | ------------------ | ---------------- |
| SESSION_LIFETIME      | 120åˆ†              | 1440åˆ†ï¼ˆ24æ™‚é–“ï¼‰ |
| RefreshCsrfToken      | ã‚ã‚Šï¼ˆéåº¦ï¼‰       | âŒ å‰Šé™¤          |
| VerifyCsrfToken       | ã‚«ã‚¹ã‚¿ãƒ ç‰ˆï¼ˆéåº¦ï¼‰ | âœ… æ¨™æº–ç‰ˆã®ã¿    |
| regenerate_on_request | trueï¼ˆéåº¦ï¼‰       | ãªã—             |
| ãƒãƒ³ãƒ‰ãƒ©æ•°            | 4æ®µéš              | 1æ®µéš            |
| ã‚»ãƒƒã‚·ãƒ§ãƒ³å®‰å®šæ€§      | ä½                 | é«˜               |
| 419ã‚¨ãƒ©ãƒ¼ç™ºç”Ÿ         | é »ç¹               | ãªã—ï¼ˆæœŸå¾…å€¤ï¼‰   |

---

## âœ¨ å®Ÿè£…ã®åŸå‰‡

> **ã‚·ãƒ³ãƒ—ãƒ«ã•**ã¯å …ç‰¢æ€§ã‚’ç”Ÿã‚€

- å¤šå±¤é˜²å¾¡ã¯ä¸è¦ = Laravel ãŒæ¨™æº–ã§ CSRF ä¿è­·
- ã‚«ã‚¹ã‚¿ãƒ ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢ã¯æœ€å°é™ = ãƒã‚°ã®æ¸©åºŠ
- ã‚»ãƒƒã‚·ãƒ§ãƒ³è¨­å®šã¯å˜ä¸€ = ä¸€è²«æ€§ç¢ºä¿
- ãƒ†ã‚¹ãƒˆã‚‚ãƒ†ã‚¹ãƒˆç’°å¢ƒè¨­å®šã§ã‚·ãƒ³ãƒ—ãƒ«ã« = æœ¬ç•ªç’°å¢ƒã¨åŒæœŸ

---

## âš ï¸ é‡è¦: æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—

1. **ã™ã¹ã¦ã®å¤‰æ›´ã‚’ã‚³ãƒŸãƒƒãƒˆ**

    ```bash
    git add -A
    git commit -m "CSRF token 419 error: minimal fix - restore to standard middleware"
    ```

2. **ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ã‚¯ãƒªã‚¢**

    ```bash
    php artisan config:clear
    php artisan route:clear
    ```

3. **ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ**

    ```bash
    npx playwright test
    ```

4. **ãƒ–ãƒ©ã‚¦ã‚¶ã§å‹•ä½œç¢ºèª**
    - ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚³ãƒ¼ãƒ‰å…¥åŠ›
    - ãƒ­ã‚°ã‚¤ãƒ³
    - ç·´ç¿’å•é¡Œ
    - ãƒœã‚¿ãƒ³æ“ä½œå…¨èˆ¬

---

## ğŸ” ã‚‚ã— 419 ã‚¨ãƒ©ãƒ¼ãŒå‡ºãŸå ´åˆ

1. **ã‚»ãƒƒã‚·ãƒ§ãƒ³ãƒ‰ãƒ©ã‚¤ãƒç¢ºèª**

    ```bash
    redis-cli ping  # Redis ãŒå‹•ã„ã¦ã„ã‚‹ã‹
    ```

2. **ãƒ­ã‚°ç¢ºèª**

    ```bash
    tail storage/logs/laravel.log | grep CSRF
    ```

3. **DBæ¥ç¶šç¢ºèª**

    ```bash
    php artisan tinker
    >>> DB::connection('mysql')->select('select 1')  # DBæ¥ç¶šãƒ†ã‚¹ãƒˆ
    ```

4. **SESSION_LIFETIME ãŒ 1440 ã«ãªã£ã¦ã„ã‚‹ã‹**
    ```bash
    php artisan tinker
    >>> config('session.lifetime')  # 1440 ãŒè¿”ã•ã‚Œã‚‹ã‹
    ```

---

## ğŸ“š å‚è€ƒè³‡æ–™

- [Laravel CSRF Protection - Official Docs](https://laravel.com/docs/11.x/csrf)
- [Session Configuration - Official Docs](https://laravel.com/docs/11.x/session)
- [Illuminate\Foundation\Http\Middleware\VerifyCsrfToken - Source](https://github.com/laravel/framework/blob/11.x/src/Illuminate/Foundation/Http/Middleware/VerifyCsrfToken.php)

---

## ğŸ’¡ æ•™è¨“

å•é¡Œè§£æ±ºæ™‚ã¯ã€ä»¥ä¸‹ã®åŸå‰‡ã«å¾“ã†ã¹ã:

1. **ã‚ªãƒªã‚¸ãƒŠãƒ«ã®çŠ¶æ…‹ã«æˆ»ã™** - ä½•ãŒå£Šã‚ŒãŸã‹ã‚’æŠŠæ¡
2. **æœ€å°é™ã®ä¿®æ­£ã‚’åŠ ãˆã‚‹** - å‰¯ä½œç”¨ã‚’æœ€å°åŒ–
3. **æ¨™æº–æ©Ÿèƒ½ã‚’ä¿¡é ¼ã™ã‚‹** - ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã®å®Ÿè£…ã‚’æ´»ç”¨
4. **ãƒ†ã‚¹ãƒˆã§æ¤œè¨¼ã™ã‚‹** - ä¿®æ­£ã®åŠ¹æœã‚’ç¢ºèª

---

å®Ÿè£…å®Œäº†æ—¥: 2025å¹´12æœˆ12æ—¥
