# Draw.io用 - ユーザーフロー（認証＆試験実施）

## 🔐 ユーザー登録～ログインフロー

```
START
  │
  ▼
┌──────────────────────┐
│  Welcome Page        │
│  GET /               │
└──────────┬───────────┘
           │
   「新規登録」or「ログイン」
           │
     ┌─────┴─────┐
     │           │
     ▼           ▼
┌──────────┐  ┌────────────┐
│ 登録画面  │  │ ログイン画面│
│ /register│  │ /login     │
└────┬─────┘  └─────┬──────┘
     │              │
     ▼ POST         ▼ POST
┌──────────────────────────────┐
│ AuthController::register     │
│ または                        │
│ AuthController::login        │
│ - バリデーション             │
│ - 入力値確認                 │
└──────┬───────────────────────┘
       │
       ▼
┌─────────────────────────────┐
│ Database Query              │
│ SELECT * FROM users WHERE  │
│ email = ?                   │
└──────┬──────────────────────┘
       │
  ┌────┴──────────────────┐
  │ Login?               Register?
  │                      │
  ▼ (password verify)    ▼ (hash password)
┌──────────────────┐  ┌──────────────────┐
│ Check hash pwd   │  │ INSERT INTO users│
└────┬─────────────┘  └───┬──────────────┘
     │                    │
     ▼                    ▼
  MATCH              ┌──────────────────┐
  or NO?             │ User Created ✓   │
  │                 │ (confirm email)  │
  ├─ NO             └──────────────────┘
  │  ▼
  │ ┌────────────────┐
  │ │ Error Message  │
  │ │ "Invalid email"│
  │ └────┬───────────┘
  │      │
  │      ▼
  │   Redirect to
  │   Login Page
  │
  ├─ YES
  │  ▼
  ┌─────────────────────┐
  │ Session Created     │
  │ - user_id           │
  │ - authenticated_at  │
  └─────┬───────────────┘
        │
        ▼
┌─────────────────────────────┐
│ 認証完了                      │
│ Redirect to /dashboard      │
│ または                       │
│ Redirect to /exam          │
└─────────────────────────────┘
```

## 📝 試験実施フロー（認証ユーザー）

```
START: ユーザーがログイン済み
  │
  ▼
┌──────────────────────┐
│  Dashboard           │
│  (試験一覧表示)      │
└──────┬───────────────┘
       │
       │ (受験可能なイベント表示)
       │
       ▼
┌──────────────────────┐
│  試験選択             │
│  (イベント選択)      │
└──────┬───────────────┘
       │
       ▼
┌──────────────────────────────────┐
│  ExamController::start           │
│  POST /exam/{eventId}/start      │
│                                  │
│  - イベント情報確認              │
│  - セッション作成                │
│  - session_uuid生成              │
└──────┬───────────────────────────┘
       │
       ▼
┌──────────────────────────────────────┐
│  CREATE exam_sessions                │
│  ┌─ user_id                          │
│  ├─ event_id                         │
│  ├─ session_uuid                     │
│  ├─ started_at = NOW()               │
│  ├─ current_part = 1                 │
│  ├─ remaining_time = 120 (min)       │
│  └─ security_log = {}                │
└──────┬───────────────────────────────┘
       │
       ▼
┌──────────────────────────────────────┐
│  試験開始画面                        │
│  GET /exam/{sessionId}/part/1       │
│                                      │
│  [注意事項表示]                      │
│  - 制限時間                         │
│  - 解答後の変更不可                 │
│  - 試験中のルール                   │
└──────┬───────────────────────────────┘
       │
       │ 「開始」ボタン
       │
       ▼
┌──────────────────────────────────┐
│ Part 1: 問題表示                   │
│ (例: 30問)                        │
│                                  │
│  SELECT * FROM questions        │
│  WHERE event_id = ? AND part = 1│
│                                  │
│  SELECT * FROM choices          │
│  WHERE question_id IN (...)     │
└──────┬───────────────────────────┘
       │
       │ (進行状況表示: 1/30)
       │
┌──────────────────────────────────┐
│ LOOP: 各問題に対して              │
│                                  │
│  1. 問題文表示                    │
│  2. 選択肢表示 (A/B/C/D)          │
│  3. ユーザーが選択肢をクリック    │
│  4. Ajax で解答送信               │
│                                  │
│     POST /exam/answer           │
│     body: {                      │
│       exam_session_id           │
│       question_id               │
│       selected_choice: 'A'       │
│     }                            │
└──────┬───────────────────────────┘
       │
       ▼
┌──────────────────────────────────────┐
│  ExamController::submitAnswer        │
│  - セッション確認                    │
│  - タイムアウト確認                  │
│  - 重複解答チェック                  │
└──────┬───────────────────────────────┘
       │
       ▼
┌──────────────────────────────────────┐
│  INSERT INTO answers                │
│  ┌─ exam_session_id                 │
│  ├─ question_id                     │
│  ├─ user_choice = 'A'               │
│  ├─ is_correct = (selected == answer)
│  ├─ answered_at = NOW()              │
│  └─ created_at = NOW()               │
└──────┬───────────────────────────────┘
       │
       ▼ (Response: success)
┌──────────────────────────────────────┐
│  クライアント更新                    │
│  - 選択肢をハイライト                │
│  - 進捗カウンタ更新 (2/30)           │
│  - 次の問題を表示                    │
└──────┬───────────────────────────────┘
       │
       │
    全問題
   回答済み?
     │
     ├─ NO
     │  │ (ループ: 3/30, 4/30, ...)
     │  │
     │  ▼ (ステップ5へ戻る)
     │
     ├─ YES
     │  │ (Part 1 完了)
     │  │
     │  ▼
     │ ┌────────────────────────────┐
     │ │ Part完了画面                │
     │ │ "Part 1: 完了 (30/30)"     │
     │ │ [Part 2へ進む]             │
     │ └────────┬───────────────────┘
     │          │
     │          ▼
     │ ┌────────────────────────────┐
     │ │ Part 2実施                 │
     │ │ (同じフロー)               │
     │ └────────┬───────────────────┘
     │          │
     │          ▼
     │ ┌────────────────────────────┐
     │ │ Part 3実施                 │
     │ │ (同じフロー)               │
     │ └────────┬───────────────────┘
     │          │
     └──────────┤
                │
                ▼
┌────────────────────────────────────┐
│  全Part完了                         │
│  UPDATE exam_sessions              │
│  - status = 'completed'            │
│  - ended_at = NOW()                │
└─────────┬──────────────────────────┘
          │
          ▼
┌────────────────────────────────────┐
│  成績計算                           │
│  SELECT COUNT(*) FROM answers      │
│  WHERE exam_session_id = ?         │
│  AND is_correct = true             │
│                                    │
│  grade = (正解数/全問数) * 100     │
│  UPDATE exam_sessions              │
│  SET grade = grade                 │
└─────────┬──────────────────────────┘
          │
          ▼
┌────────────────────────────────────┐
│  結果画面                           │
│  GET /result/{sessionId}           │
│                                    │
│  表示内容:                          │
│  - 総得点                          │
│  - Part別得点                      │
│  - 結果サマリー                    │
│  - [練習問題を見る]                │
│  - [ダッシュボードに戻る]          │
└────────────────────────────────────┘
```

## 🔒 セキュリティ検知フロー（試験中）

```
試験実施中の各操作
        │
        ▼
┌──────────────────────────────┐
│ 不正行為の検知               │
└──────────────────────────────┘
        │
   ┌────┴──────────┬─────────┬─────────┐
   │               │         │         │
   ▼               ▼         ▼         ▼
┌────────┐  ┌──────────┐ ┌─────────┐ ┌────────┐
│Window  │  │Tab       │ │Right    │ │Keyboard│
│focus   │  │switch    │ │Click    │ │copy    │
│lost    │  │detected  │ │disabled │ │blocked │
└───┬────┘  └────┬─────┘ └────┬────┘ └───┬────┘
    │            │            │         │
    └────────────┼────────────┴─────────┘
                 │
                 ▼
         ┌──────────────────┐
         │ INSERT INTO      │
         │ exam_violations  │
         │                  │
         │ - violation_type │
         │ - details (JSON) │
         │ - created_at     │
         └──────┬───────────┘
                │
                ▼
         ┌──────────────────┐
         │ Violation logged │
         │ (試験は続行)      │
         └──────────────────┘
```

## 👀 練習問題閲覧フロー

```
ユーザーがログイン済み
        │
        ▼
┌──────────────────────────────┐
│ Dashboard                    │
│ [練習問題を見る]              │
└──────┬───────────────────────┘
       │
       ▼
┌──────────────────────────────────┐
│ PracticeController::index        │
│ GET /practice                    │
│                                  │
│ SELECT * FROM practice_questions │
│ GROUP BY section                 │
└──────┬───────────────────────────┘
       │
       ▼
┌──────────────────────────────────┐
│ 練習問題一覧                      │
│ - セクション別表示               │
│ - 各問題にリンク                 │
└──────┬───────────────────────────┘
       │
       │ (問題クリック)
       │
       ▼
┌──────────────────────────────────┐
│ 問題詳細ページ                    │
│ GET /practice/{id}              │
│                                  │
│ 表示内容:                        │
│ - 問題文                         │
│ - 選択肢 (A/B/C/D)              │
│ - [解説を見る]                  │
└──────┬───────────────────────────┘
       │
       │ (解説見る)
       │
       ▼
┌──────────────────────────────────┐
│ 解説表示                          │
│ - 正解                           │
│ - 詳細な解説                     │
│ - 関連知識                       │
└──────────────────────────────────┘
```
