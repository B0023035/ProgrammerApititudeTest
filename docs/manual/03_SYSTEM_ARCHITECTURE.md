# システム構成図

プログラマー適性試験システムの物理・論理構成を説明します。

## 全体システム構成

```
┌─────────────────────────────────────────────────────────────────────────────────────────┐
│                                    インターネット                                         │
└─────────────────────────────────────────────────────────────────────────────────────────┘
                                           │
                                           ▼
┌─────────────────────────────────────────────────────────────────────────────────────────┐
│                              Cloudflare (CDN/セキュリティ)                                │
│  ┌─────────────────────────────────────────────────────────────────────────────────┐    │
│  │  • DDoS保護                                                                      │    │
│  │  • SSL/TLS終端（ユーザー ↔ Cloudflare間）                                         │    │
│  │  • WAF（Web Application Firewall）                                               │    │
│  │  • キャッシュ（静的ファイル）                                                       │    │
│  └─────────────────────────────────────────────────────────────────────────────────┘    │
│                                           │                                              │
│  ドメイン: aws-sample-minmi.click          │ Cloudflare Tunnel                           │
└─────────────────────────────────────────────────────────────────────────────────────────┘
                                           │
                                           ▼
┌─────────────────────────────────────────────────────────────────────────────────────────┐
│                              Cloudflare Tunnel (cloudflared)                             │
│  ┌─────────────────────────────────────────────────────────────────────────────────┐    │
│  │  • 外向きトンネル接続（ファイアウォール不要）                                         │    │
│  │  • Origin CA証明書による暗号化（Cloudflare ↔ サーバー間）                            │    │
│  │  • トンネルID: 60eb9d8c-3154-4ff8-8192-b78045564bc3                                │    │
│  └─────────────────────────────────────────────────────────────────────────────────┘    │
└─────────────────────────────────────────────────────────────────────────────────────────┘
                                           │
                                           │ HTTPS (localhost:443)
                                           ▼
┌─────────────────────────────────────────────────────────────────────────────────────────┐
│                                  ホストマシン (WSL2/Linux)                                │
│                                                                                          │
│  ┌─────────────────────────────────────────────────────────────────────────────────┐    │
│  │                           Docker Network (app-network)                           │    │
│  │                                                                                   │    │
│  │  ┌─────────────────────────────────────────────────────────────────────────┐    │    │
│  │  │                    programmer-test-app (アプリコンテナ)                    │    │    │
│  │  │                                                                          │    │    │
│  │  │  ┌──────────────────┐  ┌──────────────────┐  ┌──────────────────┐      │    │    │
│  │  │  │    Nginx         │  │    PHP-FPM       │  │    Supervisor    │      │    │    │
│  │  │  │  (リバースプロキシ) │  │   (PHP 8.3)      │  │  (プロセス管理)   │      │    │    │
│  │  │  │                  │  │                  │  │                  │      │    │    │
│  │  │  │  Port: 80, 443   │─▶│  Port: 9000      │  │                  │      │    │    │
│  │  │  │  SSL終端         │  │  Laravel 11      │  │                  │      │    │    │
│  │  │  └──────────────────┘  └──────────────────┘  └──────────────────┘      │    │    │
│  │  │                                                                          │    │    │
│  │  │  ボリューム:                                                              │    │    │
│  │  │  • /var/www/html (アプリケーション)                                        │    │    │
│  │  │  • /etc/letsencrypt (SSL証明書)                                           │    │    │
│  │  └─────────────────────────────────────────────────────────────────────────┘    │    │
│  │                              │                        │                          │    │
│  │                              ▼                        ▼                          │    │
│  │  ┌─────────────────────────────────┐  ┌─────────────────────────────────┐      │    │
│  │  │   programmer-test-db            │  │   programmer-test-redis         │      │    │
│  │  │   (データベースコンテナ)          │  │   (キャッシュコンテナ)            │      │    │
│  │  │                                 │  │                                 │      │    │
│  │  │   MySQL 8.0                     │  │   Redis 7 Alpine                │      │    │
│  │  │   Port: 3306                    │  │   Port: 6379                    │      │    │
│  │  │                                 │  │                                 │      │    │
│  │  │   ボリューム:                    │  │   ボリューム:                    │      │    │
│  │  │   • mysql-data:/var/lib/mysql   │  │   • redis-data:/data            │      │    │
│  │  └─────────────────────────────────┘  └─────────────────────────────────┘      │    │
│  │                                                                                   │    │
│  └─────────────────────────────────────────────────────────────────────────────────┘    │
│                                                                                          │
│  永続化ボリューム:                                                                         │
│  • programmeraptitudetest_mysql-data (データベース)                                        │
│  • programmeraptitudetest_redis-data (セッション・キャッシュ)                                │
│  • programmeraptitudetest_app-storage (アップロードファイル)                                 │
│  • programmeraptitudetest_app-cache (Laravelキャッシュ)                                     │
│                                                                                          │
└─────────────────────────────────────────────────────────────────────────────────────────┘
```

---

## Docker構成詳細

### docker-compose.production.yml の構成

```yaml
サービス構成:
├── app (programmer-test-app)
│   ├── イメージ: カスタムビルド (Dockerfile.production)
│   ├── ポート: 80:80, 443:443
│   ├── 依存: db, redis
│   └── ヘルスチェック: /health エンドポイント
│
├── db (programmer-test-db)
│   ├── イメージ: mysql:8.0
│   ├── ポート: 3306:3306
│   └── ヘルスチェック: mysqladmin ping
│
├── redis (programmer-test-redis)
│   ├── イメージ: redis:7-alpine
│   ├── ポート: 6379:6379
│   └── ヘルスチェック: redis-cli ping
│
└── certbot (programmer-test-certbot)
    └── イメージ: certbot/certbot (SSL証明書管理)
```

### ネットワーク構成

```
app-network (bridge)
├── programmer-test-app
│   └── IP: 動的割当
├── programmer-test-db
│   └── hostname: db
└── programmer-test-redis
    └── hostname: redis
```

---

## セキュリティ構成

### 通信の暗号化

```
┌─────────┐     HTTPS      ┌─────────────┐     HTTPS      ┌─────────────┐
│ ユーザー │──────────────▶│ Cloudflare  │───────────────▶│ Nginx       │
│         │   (TLS 1.3)    │             │  (Origin CA)   │ (Port 443)  │
└─────────┘                └─────────────┘                └─────────────┘
```

### 認証フロー

```
┌─────────────────────────────────────────────────────────────────────┐
│                           認証システム                               │
├─────────────────────────────────────────────────────────────────────┤
│                                                                      │
│  ┌─────────────┐    ┌─────────────┐    ┌─────────────┐             │
│  │ 管理者認証   │    │ ユーザー認証 │    │ ゲスト認証   │             │
│  │ /admin/login│    │ /login      │    │ パスフレーズ │             │
│  └──────┬──────┘    └──────┬──────┘    └──────┬──────┘             │
│         │                  │                  │                      │
│         ▼                  ▼                  ▼                      │
│  ┌─────────────────────────────────────────────────────────────┐    │
│  │                    Redis セッションストア                      │    │
│  │                    SESSION_DRIVER=redis                       │    │
│  └─────────────────────────────────────────────────────────────┘    │
│                                                                      │
└─────────────────────────────────────────────────────────────────────┘
```

---

## データフロー

### 試験実施フロー

```
┌─────────┐                                           ┌─────────────┐
│ 受験者   │                                           │  サーバー   │
└────┬────┘                                           └──────┬──────┘
     │                                                        │
     │  1. パスフレーズ入力                                    │
     │───────────────────────────────────────────────────────▶│
     │                                                        │
     │  2. セッション作成 & 問題取得                            │
     │◀───────────────────────────────────────────────────────│
     │                                                        │
     │  3. 回答送信（各問題）                                   │
     │───────────────────────────────────────────────────────▶│
     │                                                        │  ┌──────────┐
     │                                                        │──│ MySQL    │
     │                                                        │  │ (保存)   │
     │  4. 全問完了時: 採点・ランク計算                         │  └──────────┘
     │◀───────────────────────────────────────────────────────│
     │                                                        │
     │  5. 結果表示                                            │
     │◀───────────────────────────────────────────────────────│
     │                                                        │
```

---

## スケーラビリティ

### 現在の構成（150人同時接続対応）

```
リソース割当:
├── App Container
│   ├── CPU: 2-4 cores
│   ├── Memory: 2-4 GB
│   └── PHP-FPM workers: 動的
│
├── MySQL Container
│   ├── max_connections: 500
│   ├── innodb_buffer_pool_size: 1G
│   └── Memory: 2 GB
│
└── Redis Container
    ├── maxmemory: 512 MB
    ├── maxclients: 1000
    └── Memory: 512 MB
```

### スケールアップオプション

```
将来の拡張:
├── ロードバランサー追加
├── アプリコンテナの水平スケール
├── データベースのリードレプリカ
└── Redisクラスター化
```
