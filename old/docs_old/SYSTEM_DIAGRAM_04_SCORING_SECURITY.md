# システム構成図 - Part 3: 成績計算・セキュリティ

## 📊 成績計算フロー

```
┌─────────────────────────────────────────────────────────────────┐
│ [試験提出]                                                      │
│ ユーザーが「試験を提出」ボタンをクリック                        │
│    POST /exam/submit                                           │
│         ↓                                                       │
│ [ExamController::submitExam()]                                │
│    │                                                           │
│    ├─ 1️⃣ 試験セッション終了マーク                              │
│    │   ├─ UPDATE exam_sessions SET                           │
│    │   │  status = 'completed',                              │
│    │   │  completed_at = now()                               │
│    │   │       ↓ [MySQL]                                    │
│    │   └─ Redis からセッションデータ削除                       │
│    │      (キャッシュをパージ)                                │
│    │            ↓                                             │
│    ├─ 2️⃣ 解答データを確定                                     │
│    │   ├─ SELECT * FROM answers                              │
│    │   │  WHERE exam_session_id = ? ORDER BY created_at    │
│    │   │       ↓ [MySQL]                                    │
│    │   └─ Answer オブジェクト配列を取得                        │
│    │            ↓                                             │
│    └─ 3️⃣ スコアリング実行                                     │
│       └─ [ScoringService::calculate()]                       │
│          │                                                   │
│          ├─ 4️⃣ 正解カウント                                  │
│          │   ├─ Loop: 各解答に対して                         │
│          │   │  ├─ SELECT * FROM questions WHERE id = ?     │
│          │   │  ├─ 正解の choice_id と比較                  │
│          │   │  ├─ 一致? ✅ correct_count++                 │
│          │   │  └─ 不一致? ❌ スキップ                       │
│          │   │       ↓ [MySQL - キャッシュ利用]              │
│          │   └─ 例: 100問中75問正解                         │
│          │            ↓                                      │
│          ├─ 5️⃣ 素点計算                                      │
│          │   └─ raw_score = (correct_count / total) * 100   │
│          │      = (75 / 100) * 100 = 75点                  │
│          │            ↓                                      │
│          ├─ 6️⃣ 調整スコア計算（難易度による）                 │
│          │   ├─ SELECT difficulty FROM events WHERE id = ?  │
│          │   ├─ 難易度に基づく係数を取得                     │
│          │   │  ├─ 'easy' → 係数 1.0                       │
│          │   │  ├─ 'normal' → 係数 1.0                     │
│          │   │  └─ 'hard' → 係数 1.1                       │
│          │   │       ↓                                      │
│          │   └─ adjusted_score = raw_score * coefficient    │
│          │      = 75 * 1.0 = 75 点                          │
│          │            ↓                                      │
│          ├─ 7️⃣ 不正フラグ確認                                │
│          │   ├─ SELECT COUNT(*) FROM exam_violations       │
│          │   │  WHERE exam_session_id = ? AND severity = 'high'
│          │   ├─ 高度な違反 > 3件? ❌ → score = 0            │
│          │   └─ 中度な違反? → score * 0.8 (80%に減点)       │
│          │            ↓                                      │
│          └─ 8️⃣ 最終スコア確定                                │
│             ├─ final_score = adjusted_score (違反なし)      │
│             │  または                                       │
│             │  final_score = 0 (重大な違反)                │
│             │            ↓                                  │
│ [ScoreRecord]                                               │
│ UPDATE exam_sessions SET                                    │
│  raw_score = 75,                                            │
│  adjusted_score = 75,                                       │
│  violation_status = 'clean',                                │
│  final_score = 75,                                          │
│  score_finalized_at = now()                                 │
│      ↓ [MySQL]                                              │
│                                                             │
│ INSERT INTO exam_results (スナップショット保存)              │
│  exam_session_id, user_id, event_id,                        │
│  raw_score, adjusted_score, final_score,                    │
│  grade: 'A+' (スコアの グレード化)                          │
│  created_at                                                 │
│      ↓ [MySQL]                                              │
│                                                             │
│ ✅ 成績確定完了                                              │
│    キャッシュ: result:cache:{exam_session_id} に保存         │
│    (24時間キャッシュ)                                       │
└─────────────────────────────────────────────────────────────────┘
```

---

## 🔒 セキュリティアーキテクチャ

### 7層の多層防御

```
┌─────────────────────────────────────────────────────────────────┐
│ 🌐 第1層: ネットワークセキュリティ                               │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ・HTTPS/TLS 1.2+ 通信暗号化                                    │
│  ・自己署名証明書 (開発) / Let's Encrypt (本番)                 │
│  ・ポート: 80 → 443 自動リダイレクト                           │
│  ・Firewall ルール (UFW on Linux)                              │
│  ・Rate Limiting (Nginx)                                       │
│     └─ 1秒あたりリクエスト数制限                               │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘


┌─────────────────────────────────────────────────────────────────┐
│ 🔑 第2層: CSRF(クロスサイトリクエストフォージェリ) 対策           │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ・CSRF トークン自動生成 (Blade・Inertia テンプレート)         │
│  ・POSTリクエストに token パラメータ必須                        │
│  ・トークン検証ミドルウェア: VerifyCsrfToken                    │
│  ・失敗時: 419 Unprocessable Entity エラー                      │
│                                                                 │
│  実装:                                                         │
│  ┌─ フロント側                                                 │
│  │  ├─ <input type="hidden" name="_token" value="...">       │
│  │  └─ axios デフォルトヘッダに追加:                          │
│  │     headers: {                                             │
│  │       'X-CSRF-TOKEN': document.querySelector(...).value   │
│  │     }                                                      │
│  │                                                           │
│  └─ サーバー側                                                │
│     ├─ middleware('web') で自動検証                           │
│     └─ 失敗時は 419 エラー                                    │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘


┌─────────────────────────────────────────────────────────────────┐
│ 🔐 第3層: 認証・セッション管理                                  │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ・セッションベース認証 (Laravel Session)                       │
│  ・セッション保存先: Redis (高速・復元可能)                     │
│  ・HttpOnly Cookie: セッションID 格納                          │
│  ・SameSite=Strict: クロスオリジン CSRF 防止                    │
│  ・セッション有効期限: 2時間                                    │
│  ・自動ロック: 無操作 15分で再認証                             │
│                                                                 │
│  Cookie 設定:                                                  │
│  ┌─────────────────────────────────────┐                      │
│  │ Name: LARAVEL_SESSION                │                      │
│  │ Value: (暗号化セッションID)           │                      │
│  │ Domain: .example.com                 │                      │
│  │ Path: /                              │                      │
│  │ Expires: now + 2h                    │                      │
│  │ HttpOnly: ✅ (JS アクセス不可)       │                      │
│  │ Secure: ✅ (HTTPS のみ)             │                      │
│  │ SameSite: Strict                     │                      │
│  └─────────────────────────────────────┘                      │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘


┌─────────────────────────────────────────────────────────────────┐
│ 🛡️ 第4層: 入力値検証・サニタイゼーション                        │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ・FormRequest による自動検証 (バリデーション)                 │
│  ・ホワイトリスト方式: 許可する形式のみ受け入れ                │
│  ・型キャスト: 期待される型へ変換                               │
│  ・サニタイズ: 危険な文字をエスケープ                           │
│                                                                 │
│  例: LoginRequest クラス                                       │
│  ├─ email: required|email|exists:users                        │
│  ├─ password: required|string|min:8                           │
│  │                                                             │
│  └─ 検証失敗 → 422 Validation Error                            │
│                                                                 │
│  例: ExamSubmitRequest                                         │
│  ├─ exam_session_id: required|integer|exists:exam_sessions   │
│  ├─ question_id: required|integer|exists:questions           │
│  ├─ choice_id: required|integer|exists:choices               │
│  │                                                             │
│  └─ SQLインジェクション ✅ 防止                                 │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘


┌─────────────────────────────────────────────────────────────────┐
│ 🔑 第5層: SQLインジェクション対策                               │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ・Eloquent ORM: プリペアドステートメント自動使用                │
│  ・パラメータバインディング: ? / :key                           │
│  ・クエリビルダ: 生 SQL は使用不可                              │
│                                                                 │
│  安全な例:                                                      │
│  └─ User::where('email', $email)->first()                     │
│     → 内部的に SELECT * FROM users WHERE email = ?           │
│        [パラメータ: $email をバインド]                         │
│                                                                 │
│  危険な例 (禁止):                                               │
│  └─ DB::select("SELECT * FROM users WHERE email = '$email'") │
│     → SQLインジェクション脆弱性                                │
│                                                                 │
│  対策:                                                         │
│  ├─ コードレビュー: 生SQL使用を厳禁                            │
│  ├─ 静的解析: PHPSTAN による検出                              │
│  └─ テスト: SQLインジェクション攻撃テストケース                │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘


┌─────────────────────────────────────────────────────────────────┐
│ 🔍 第6層: 権限制御・アクセス制限                                │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ・Role-Based Access Control (RBAC)                           │
│  ・ユーザータイプ: user / admin / proctor / guest               │
│  ・ポリシークラス: 各リソースの権限チェック                     │
│  ・Middleware: ルート保護                                      │
│                                                                 │
│  実装例:                                                       │
│  ├─ Route::middleware('auth:admin')->group(...)               │
│  │  → admin ロールのみアクセス可                               │
│  │                                                             │
│  ├─ ExamPolicy::view($user, $exam)                            │
│  │  → 本人またはAdmin のみ確認可能                             │
│  │                                                             │
│  └─ $this->authorize('view', $exam)                           │
│     → 権限なし → 403 Forbidden                                │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘


┌─────────────────────────────────────────────────────────────────┐
│ 🚨 第7層: ロギング・監視・不正検知                               │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ・全リクエスト/レスポンス記録 (Nginx access.log)               │
│  ・エラー・例外 記録 (Laravel error.log)                       │
│  ・操作ログ: ユーザー操作時間・変更内容記録                     │
│  ・不正検知 (ViolationDetector)                                │
│     ├─ 異常なペースでの解答                                   │
│     ├─ IP/デバイス変化                                         │
│     ├─ タイムゾーン違反                                        │
│     └─ 複数ユーザー同時アクセス                                │
│                                                                 │
│  ・アラート: 重大な違反検出時にメール通知                       │
│  ・Sentry 統合: 外部エラートラッキング                          │
│  ・ダッシュボード: 疑わしいアクティビティを可視化               │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

---

**⏸️ 続きは次のファイルで...**
