# システム構成図 - Part 1: インフラストラクチャ層

## 🌐 全体システムアーキテクチャ

```
┌────────────────────────────────────────────────────────────────────┐
│                         クライアント層                              │
│                                                                    │
│  ┌──────────────┐      ┌──────────────┐      ┌──────────────┐   │
│  │   PC 用      │      │  スマートフォン│      │   管理者用    │   │
│  │   ブラウザ   │      │   ブラウザ    │      │  ブラウザ    │   │
│  │              │      │              │      │              │   │
│  │ Vue 3 UI    │      │ Vue 3 UI    │      │ Vue 3 UI    │   │
│  └──────────────┘      └──────────────┘      └──────────────┘   │
│         │                      │                      │            │
└─────────┼──────────────────────┼──────────────────────┼────────────┘
          │                      │                      │
          │      HTTP/HTTPS      │                      │
          │     with CSRF Token  │                      │
          └──────────┬───────────┴──────────────────────┘
                     │
                     ▼
┌────────────────────────────────────────────────────────────────────┐
│                    ネットワーク・セキュリティ層                      │
│                                                                    │
│  ┌────────────────────────────────────────────────────────────┐  │
│  │                                                            │  │
│  │  Nginx (リバースプロキシ・負荷分散)                       │  │
│  │  ・HTTPS/SSL ターミネーション                             │  │
│  │  ・リクエストルーティング                                 │  │
│  │  ・キャッシング (静的ファイル)                            │  │
│  │  ・Rate Limiting                                         │  │
│  │                                                            │  │
│  └────────────────────────────────────────────────────────────┘  │
│                             │                                      │
└─────────────────────────────┼──────────────────────────────────────┘
                              │
                              ▼
┌────────────────────────────────────────────────────────────────────┐
│                      アプリケーション層                             │
│                      (Laravel + PHP 8.4)                           │
│                                                                    │
│  ┌────────────────────────────────────────────────────────────┐  │
│  │                    ミドルウェアスタック                    │  │
│  │  ┌──────────────────────────────────────────────────────┐ │  │
│  │  │ 1. CORS ヘッダー処理                                │ │  │
│  │  │ 2. CSRF トークン検証                                │ │  │
│  │  │ 3. Authentication (セッション/JWT)                 │ │  │
│  │  │ 4. Authorization (権限チェック)                    │ │  │
│  │  │ 5. Request ログ記録                                │ │  │
│  │  └──────────────────────────────────────────────────────┘ │  │
│  │                         ▼                                   │  │
│  │  ┌──────────────────────────────────────────────────────┐ │  │
│  │  │            ルーティング・ディスパッチ                 │ │  │
│  │  │  (Web・API・Admin ルート分岐)                      │ │  │
│  │  └──────────────────────────────────────────────────────┘ │  │
│  │    │           │            │              │              │  │
│  │    ▼           ▼            ▼              ▼              │  │
│  │  ┌────────┐ ┌────────┐ ┌────────┐   ┌──────────┐         │  │
│  │  │ Auth   │ │ Exam   │ │Result  │   │  Admin   │         │  │
│  │  │Control │ │Control │ │Control │   │ Control  │         │  │
│  │  └────────┘ └────────┘ └────────┘   └──────────┘         │  │
│  │       │          │           │           │               │  │
│  │       ▼          ▼           ▼           ▼               │  │
│  │  ┌──────────────────────────────────────────────────┐   │  │
│  │  │           ビジネスロジック層 (Services)           │   │  │
│  │  │                                                  │   │  │
│  │  │  ・AuthService (認証・セッション管理)            │   │  │
│  │  │  ・ExamService (試験ロジック)                   │   │  │
│  │  │  ・ScoringService (成績計算)                    │   │  │
│  │  │  ・ViolationService (不正検知)                  │   │  │
│  │  │  ・AdminService (管理機能)                      │   │  │
│  │  │  ・ValidationService (データ検証)               │   │  │
│  │  │  ・CacheService (キャッシング)                  │   │  │
│  │  │                                                  │   │  │
│  │  └──────────────────────────────────────────────────┘   │  │
│  │                     │                                    │  │
│  │                     ▼                                    │  │
│  │  ┌──────────────────────────────────────────────────┐   │  │
│  │  │         データアクセス層 (ORM: Eloquent)          │   │  │
│  │  │                                                  │   │  │
│  │  │  ┌────────────┐  ┌────────────┐  ┌──────────┐ │   │  │
│  │  │  │ User Model │  │Event Model │  │Answer    │ │   │  │
│  │  │  │            │  │            │  │Model     │ │   │  │
│  │  │  │ Methods:   │  │ Methods:   │  │          │ │   │  │
│  │  │  │ ・Auth()   │  │ ・create() │  │・store() │ │   │  │
│  │  │  │ ・getByID()│  │ ・update() │  │          │ │   │  │
│  │  │  │            │  │            │  │          │ │   │  │
│  │  │  └────────────┘  └────────────┘  └──────────┘ │   │  │
│  │  │         ... その他多数のモデル                  │   │  │
│  │  └──────────────────────────────────────────────────┘   │  │
│  │              │                                           │  │
│  └──────────────┼───────────────────────────────────────────┘  │
│                 │ SQL クエリ                                   │
│                 ▼                                              │
└─────────────────┼──────────────────────────────────────────────┘
                  │
                  ▼
┌────────────────────────────────────────────────────────────────────┐
│                        データベース層                               │
│                                                                    │
│  ┌────────────────────────────────────────────────────────────┐  │
│  │                                                            │  │
│  │  MySQL 8.0 サーバー                                       │  │
│  │                                                            │  │
│  │  ┌─────────────────┐  ┌──────────────────────────┐       │  │
│  │  │ 認証・ユーザー   │  │ 試験・問題・解答管理      │       │  │
│  │  │                 │  │                          │       │  │
│  │  │ users           │  │ events                  │       │  │
│  │  │ admins          │  │ exam_sessions           │       │  │
│  │  │ sessions        │  │ questions               │       │  │
│  │  │ password_resets │  │ choices                 │       │  │
│  │  │                 │  │ answers                 │       │  │
│  │  │                 │  │ practice_questions      │       │  │
│  │  │                 │  │ exam_violations         │       │  │
│  │  └─────────────────┘  └──────────────────────────┘       │  │
│  │           │                        │                      │  │
│  │           └────────────┬───────────┘                      │  │
│  │                        │                                  │  │
│  │             (リレーショナル結合・トランザクション)          │  │
│  │                                                            │  │
│  └────────────────────────────────────────────────────────────┘  │
│                                                                    │
└────────────────────────────────────────────────────────────────────┘


┌────────────────────────────────────────────────────────────────────┐
│                    キャッシング・セッション層                        │
│                                                                    │
│  ┌──────────────┐        ┌──────────────┐      ┌──────────────┐  │
│  │   Redis      │        │   Memcached  │      │ File Cache   │  │
│  │  (セッション) │        │  (クエリ結果)  │      │  (静的ファイル)│  │
│  │              │        │              │      │              │  │
│  │ ・ユーザー    │        │ ・試験問題    │      │ ・CSS・JS    │  │
│  │   セッション │        │ ・成績データ   │      │ ・イメージ   │  │
│  │ ・試験タイマー │        │ ・ユーザー情報 │      │ ・ビルド時   │  │
│  │               │        │              │      │              │  │
│  └──────────────┘        └──────────────┘      └──────────────┘  │
│                                                                    │
└────────────────────────────────────────────────────────────────────┘


┌────────────────────────────────────────────────────────────────────┐
│                      ロギング・監視層                               │
│                                                                    │
│  ┌──────────────┐        ┌──────────────┐      ┌──────────────┐  │
│  │  Laravel Log │        │ Access Log   │      │ Error Log    │  │
│  │  (storage/)  │        │  (Nginx)     │      │ (Sentry等)   │  │
│  │              │        │              │      │              │  │
│  │ ・エラー記録 │        │ ・リクエスト │      │ ・例外追跡   │  │
│  │ ・デバッグ   │        │ ・レスポンス │      │ ・エラー通知 │  │
│  │ ・操作ログ   │        │ ・パフォーマンス      │              │  │
│  │              │        │              │      │              │  │
│  └──────────────┘        └──────────────┘      └──────────────┘  │
│                                                                    │
└────────────────────────────────────────────────────────────────────┘
```

---

## 📊 デプロイメント環境構成

### 🐳 Docker コンテナ構成

```
Docker Host (Linux/WSL)
│
├─ 🐳 laravel.test (PHP-FPM + Laravel アプリケーション)
│  ├─ ポート: 80 → Host:80
│  ├─ ポート: 5173 → Host:5173 (Vite Dev Server)
│  ├─ ボリューム: /var/www/html → ./
│  └─ ネットワーク: sail
│
├─ 🐳 nginx (Webサーバー)
│  ├─ ポート: 80/443
│  ├─ ボリューム: ./docker/nginx/
│  └─ ネットワーク: sail
│
├─ 🐳 mysql (データベース)
│  ├─ ポート: 3306 → Host:3306
│  ├─ ボリューム: sail-mysql:/var/lib/mysql
│  └─ ネットワーク: sail
│
├─ 🐳 redis (キャッシュ・セッション)
│  ├─ ポート: 6379 → Host:6379
│  └─ ネットワーク: sail
│
├─ 🐳 meilisearch (フルテキスト検索)
│  ├─ ポート: 7700
│  └─ ネットワーク: sail
│
├─ 🐳 mailpit (メール送信テスト)
│  ├─ ポート: 1025, 8025
│  └─ ネットワーク: sail
│
└─ 🐳 selenium (E2E テスト)
   └─ ネットワーク: sail
```

---

**⏸️ 続きは次のファイルで...**
