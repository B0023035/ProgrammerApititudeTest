# Draw.io用 - ゲストユーザーフロー

## 🌐 ゲスト試験実施フロー

```
START: ユーザーが /にアクセス
  │
  ▼
┌──────────────────────────────────┐
│  Welcome Page                    │
│  GET /                           │
│                                  │
│  [セッションコードを入力]          │
│  または                          │
│  [ログイン] / [新規登録]          │
└──────┬───────────────────────────┘
       │
       │ ゲストユーザー: セッションコード入力
       │
       ▼
┌──────────────────────────────────┐
│  セッションコード入力画面         │
│  例: EXAM2024001                 │
└──────┬───────────────────────────┘
       │
       ▼ POST /session-code/verify
┌────────────────────────────────────┐
│  SessionCodeController::verify     │
│  - コード形式確認                  │
│  - バリデーション                  │
└──────┬─────────────────────────────┘
       │
       ▼
┌────────────────────────────────────┐
│  Database Query                    │
│  SELECT * FROM events              │
│  WHERE passphrase = ?              │
│                                    │
│  イベントが存在？                  │
│  開始時刻は過ぎた？                │
│  終了時刻内？                      │
└──────┬─────────────────────────────┘
       │
  ┌────┴─────────┐
  │              │
  ▼ OK          ▼ NO
┌─────────┐  ┌──────────────┐
│ 確認OK  │  │ エラー表示   │
└────┬────┘  │ "コード無効" │
     │       └──────┬───────┘
     │              │
     │              ▼
     │          Welcome Page
     │          にリダイレクト
     │
     ▼
┌───────────────────────────────────┐
│  ゲスト情報入力画面                │
│  GET /guest/info                  │
│                                   │
│  入力項目:                         │
│  - 名前                           │
│  - メール (オプション)             │
│  - 学年 (オプション)               │
│  - 企業名 (オプション)             │
└──────┬────────────────────────────┘
       │
       │ (ユーザー入力)
       │
       ▼ POST /guest/info/submit
┌──────────────────────────────────┐
│  GuestExamController::infoSubmit │
│  - バリデーション                │
│  - セッション生成                │
└──────┬───────────────────────────┘
       │
       ▼
┌───────────────────────────────────┐
│  セッション作成                    │
│  (認証ユーザーの場合と同様)        │
│                                   │
│  - session_uuid生成              │
│  - ゲスト情報キャッシュ           │
│  - started_at記録                │
└──────┬────────────────────────────┘
       │
       ▼
┌──────────────────────────────────┐
│  ゲスト試験開始                    │
│  GET /guest/exam/part/1          │
│                                  │
│  [注意事項表示]                  │
│  - タイムリミット: 120分         │
│  - 問題は一度しか表示されない     │
│  - 解答後は変更不可              │
└──────┬───────────────────────────┘
       │
       │ 「試験を開始」
       │
       ▼
┌──────────────────────────────────┐
│ Part 1: 問題表示                   │
│ GET /guest/exam/part/1           │
│ (例: 30問)                       │
└──────┬───────────────────────────┘
       │
       ▼
┌──────────────────────────────────┐
│ LOOP: 各問題に対して              │
│                                  │
│ 1. 問題表示 (テキスト + 画像)     │
│ 2. 選択肢表示 (A/B/C/D)          │
│ 3. ユーザー選択                  │
│ 4. Ajax で解答送信               │
│                                  │
│    POST /guest/exam/part/{n}/answer
│    body: {                       │
│      question_id                │
│      selected_choice: 'A'        │
│    }                             │
└──────┬───────────────────────────┘
       │
       ▼
┌────────────────────────────────┐
│ GuestExamController::answer    │
│ - セッション確認              │
│ - タイムアウト確認            │
│ - 解答記録 (テンポラリ)        │
└──────┬───────────────────────┘
       │
       ▼
    全問題回答?
       │
    ┌──┴──┐
    │     │
   NO    YES
    │     │
    ▼     ▼
 次問題 Part完了
    │
 ...30
 問目
    │
    ▼
┌────────────────────────────────┐
│ Part 2へ進む                    │
│ (同じフロー)                    │
└──────┬───────────────────────┘
       │
       ▼
┌────────────────────────────────┐
│ Part 3へ進む                    │
│ (同じフロー)                    │
└──────┬───────────────────────┘
       │
       ▼
┌────────────────────────────────┐
│  全Part完了                     │
│  (ゲスト試験終了)               │
└──────┬───────────────────────┘
       │
       ▼
┌────────────────────────────────┐
│  成績計算                       │
│  (全問題の正解/不正解を集計)     │
│                                │
│  grade = (正解数/全問数)*100   │
└──────┬───────────────────────┘
       │
       ▼
┌────────────────────────────────┐
│  結果画面                       │
│  GET /guest/result             │
│                                │
│  表示内容:                      │
│  - ゲストが入力した名前         │
│  - 総得点                      │
│  - Part別得点                  │
│  - 結果レベル表示              │
│  - [もう一度受ける]            │
│  - [ホームに戻る]              │
└────────────────────────────────┘
```

## 🏢 ゲスト試験データ保存方法

```
ゲストセッション中:
  ├─ session_uuid
  ├─ event_id
  ├─ ゲスト情報 (キャッシュ/DB)
  ├─ 解答記録 (テンポラリ)
  └─ タイムスタンプ

試験完了時:
  ├─ 成績を計算
  ├─ 結果をDB保存 (optional)
  │  OR
  │  メール送信 (optional)
  └─ キャッシュクリア

※ ゲストは users テーブルに登録されない
※ 結果は exam_sessions テーブルに user_id = NULL で保存される可能性
```

## 📊 ゲストと認証ユーザーの比較

```
┌──────────────────┬──────────────┬──────────────────┐
│ 機能              │ ゲスト       │ 認証ユーザー      │
├──────────────────┼──────────────┼──────────────────┤
│ アクセス方法      │ セッション   │ ログイン         │
│                  │ コード       │                  │
├──────────────────┼──────────────┼──────────────────┤
│ 本番試験          │ ✓ 可能      │ ✓ 可能          │
├──────────────────┼──────────────┼──────────────────┤
│ 練習問題          │ ✗ 不可      │ ✓ 可能          │
├──────────────────┼──────────────┼──────────────────┤
│ 結果保存          │ ✓ セッション│ ✓ DB永続保存    │
├──────────────────┼──────────────┼──────────────────┤
│ 過去試験確認      │ ✗ 不可      │ ✓ 可能          │
├──────────────────┼──────────────┼──────────────────┤
│ 個人情報登録      │ 最小限       │ 登録必須         │
├──────────────────┼──────────────┼──────────────────┤
│ メール送信        │ オプション   │ ✓ 可能          │
└──────────────────┴──────────────┴──────────────────┘
```
